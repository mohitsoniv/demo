// Jenkinsfile — Declarative pipeline (Windows agent)
// Copy this file to the repository root as "Jenkinsfile".
// Edit the tool names in the `tools {}` block to match Manage Jenkins → Global Tool Configuration.
// If your agent is Linux, replace `bat` with `sh` where indicated.

pipeline {
  agent any

  // Make sure these exact names exist in Manage Jenkins -> Global Tool Configuration
  tools {
    jdk 'JDK11'         // <-- change to the exact JDK name you configured (case-sensitive)
    maven 'MAVEN_HOME'  // <-- change to the exact Maven name you configured
  }

  environment {
    MVN_ARGS = '-B' // Maven batch mode
  }

  stages {
    stage('Verify Tools') {
      steps {
        // Diagnostic output to make failures obvious in the console
        bat 'echo ========== ENV =========='
        bat 'echo USER=%USERNAME%'
        bat 'echo JAVA_HOME=%JAVA_HOME%'
        bat 'echo PATH=%PATH%'
        bat 'echo ========== JAVA =========='
        bat 'where java || echo "where java returned non-zero"'
        bat 'java -version || echo "java -version failed"'
        bat 'echo ========== MAVEN =========='
        bat 'where mvn || echo "where mvn returned non-zero"'
        bat 'mvn -version || echo "mvn -version failed"'
      }
    }

    stage('Welcome Stage') {
      steps {
        echo "Welcome to the Jenkins pipeline"
      }
    }

    stage('Clean') {
      steps {
        script {
          // Fail fast with a clear message if Java isn't available
          if (!env.JAVA_HOME?.trim()) {
            error("""
              JAVA_HOME is not set for the agent.
              Fix options:
                1) Configure a JDK under Manage Jenkins -> Global Tool Configuration and set the exact name in tools { jdk '<name>' }.
                2) Install a JDK on the agent and set the machine-level JAVA_HOME (then restart Jenkins service).
                3) Temporarily set JAVA_HOME in this pipeline environment block (not recommended long-term).
            """.stripIndent())
          }
        }
        // Windows agents use bat. If you're on Linux agents, change to: sh 'mvn clean'
        bat 'mvn clean'
      }
    }

    stage('Build') {
      steps {
        bat "mvn install ${env.MVN_ARGS}"
      }
    }

    stage('Success Stage') {
      steps {
        echo "Pipeline executed successfully"
      }
    }
  }

  post {
    always {
      echo "Pipeline finished with status: ${currentBuild.currentResult}"
    }
    success {
      echo 'Post: success actions (optional)'
    }
    failure {
      echo 'Post: failure actions — check JAVA_HOME, tool names and agent configuration'
    }
  }
}
